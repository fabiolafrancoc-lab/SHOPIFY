<style>
  :root {
    --sc-bg: #0a0a0f;
    --sc-bg2: #12121e;
    --sc-bg3: #16162a;
    --sc-bg4: #1c1c32;
    --sc-cyan: #0ea5e9;
    --sc-magenta: #ec4899;
    --sc-magenta-dark: #db2777;
    --sc-green: #10b981;
    --sc-red: #ef4444;
    --sc-muted: rgba(255, 255, 255, 0.55);
    --sc-white: #ffffff;
  }

  .sc-registro-page {
    background: var(--sc-bg);
    color: var(--sc-white);
    min-height: 100vh;
  }

  .sc-registro-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    min-height: 100vh;
  }

  .sc-registro-photo {
    position: sticky;
    top: 0;
    height: 100vh;
    overflow: hidden;
  }

  .sc-registro-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center top;
    display: block;
  }

  .sc-registro-photo-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to right, transparent 55%, var(--sc-bg) 100%),
      linear-gradient(to top, rgba(10, 10, 15, 0.75) 0%, transparent 45%);
  }

  .sc-registro-caption {
    position: absolute;
    bottom: 48px;
    left: 36px;
    right: 36px;
  }

  .sc-registro-eyebrow {
    display: block;
    color: var(--sc-cyan);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  .sc-registro-title {
    font-family: 'DM Serif Display', serif;
    font-size: clamp(22px, 2.2vw, 34px);
    line-height: 1.25;
  }

  .sc-registro-title span {
    color: var(--sc-magenta);
  }

  .sc-registro-form {
    padding: 48px 48px 80px;
    background: var(--sc-bg);
  }

  @media (max-width: 900px) {
    .sc-registro-layout { grid-template-columns: 1fr; }
    .sc-registro-photo { display: none; }
    .sc-registro-form { padding: 32px 24px 80px; }
  }

  .sc-page-title {
    font-family: 'DM Serif Display', serif;
    font-size: 28px;
    margin-bottom: 8px;
    text-align: center;
  }

  .sc-page-subtitle {
    text-align: center;
    color: var(--sc-muted);
    font-size: 14px;
    margin-bottom: 28px;
  }

  .sc-section-title {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--sc-cyan);
    margin: 20px 0 10px;
  }

  .sc-form {
    max-width: 640px;
    margin: 0 auto;
  }

  .sc-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 12px;
  }

  .sc-label {
    font-size: 12px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.75);
  }

  .sc-input,
  .sc-select {
    background: var(--sc-bg4);
    border: 1.5px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 11px 14px;
    color: var(--sc-white);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .sc-input::placeholder {
    color: rgba(255, 255, 255, 0.25);
  }

  .sc-input:focus,
  .sc-select:focus {
    outline: none;
    border-color: var(--sc-cyan);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
  }

  .sc-summary {
    background: var(--sc-bg3);
    border-radius: 12px;
    padding: 16px 20px;
    margin: 12px 0 6px;
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .sc-summary-title {
    font-size: 12px;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 10px;
  }

  .sc-summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 13px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  }

  .sc-summary-row:last-child { border-bottom: none; }

  .sc-summary-label { color: rgba(255, 255, 255, 0.6); }

  .sc-summary-value { font-weight: 600; }

  .sc-summary-value.free { color: var(--sc-green); }

  .beneficiary-card {
    background: var(--sc-bg3);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 12px;
  }

  .beneficiary-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .beneficiary-num {
    font-size: 12px;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.7);
  }

  .beneficiary-remove {
    border: none;
    background: transparent;
    color: rgba(255, 255, 255, 0.6);
    font-size: 18px;
    cursor: pointer;
  }

  .add-beneficiary {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    border-radius: 12px;
    padding: 12px 14px;
    border: 1px dashed rgba(255, 255, 255, 0.2);
    background: transparent;
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    margin-top: 4px;
  }

  .cta-primary {
    display: block;
    width: 100%;
    padding: 16px 20px;
    background: linear-gradient(135deg, var(--sc-magenta), var(--sc-magenta-dark));
    color: var(--sc-white);
    border: none;
    border-radius: 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 16px;
    font-weight: 700;
    box-shadow: 0 8px 32px rgba(236, 72, 153, 0.35);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .cta-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 16px 48px rgba(236, 72, 153, 0.45);
  }

  .cta-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .cta-subtext {
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
    margin-top: 12px;
    font-size: 12px;
    color: var(--sc-muted);
  }

  .cta-subtext svg {
    width: 16px;
    height: 16px;
    color: var(--sc-green);
  }
</style>

<div class="sc-registro-page">
  <div class="sc-registro-layout">
    <aside class="sc-registro-photo">
      <img src="{{ 'registro-photo.jpg' | asset_url }}" alt="Familia en bienestar">
      <div class="sc-registro-photo-overlay"></div>
      <div class="sc-registro-caption">
        <span class="sc-registro-eyebrow">El amor que sientes</span>
        <div class="sc-registro-title">Ahora se convierte en <span>proteccion</span></div>
      </div>
    </aside>

    <div class="sc-registro-form">
      <h1 class="sc-page-title">Estas a un paso de cuidarlos</h1>
      <p class="sc-page-subtitle">
        Llegaste hasta aqui porque sabes que el dinero no lo resuelve todo.<br>
        Ellos necesitan salud, compania y tu tranquilidad.<br>
        Son 30 dias para que tu familia lo use, lo conozca y sienta la diferencia. Asi confirmas que vale la pena.
      </p>

      <form class="sc-form" id="form-registro" onsubmit="handleRegistroSubmit(event)">
        <p class="sc-section-title">Tus datos — Estas en EE.UU.</p>

        <div class="sc-field-row" style="display: flex; gap: 1rem;">
        <div class="sc-field" style="flex: 1;">
        <label class="sc-label" for="nombre">Nombre *</label>
        <input class="sc-input" type="text" id="nombre" name="nombre" placeholder="Juan" required>
        </div>
        <div class="sc-field" style="flex: 1;">
        <label class="sc-label" for="apellido_paterno">Apellido Paterno *</label>
        <input class="sc-input" type="text" id="apellido_paterno" name="apellido_paterno" placeholder="García" required>
        </div>
      </div>


        <div class="sc-field">
          <label class="sc-label" for="email">Tu correo electronico *</label>
          <input class="sc-input" type="email" id="email" name="email" placeholder="juan@gmail.com" required>
        </div>

        <div class="sc-field">
          <label class="sc-label" for="fecha_nacimiento">Tu fecha de nacimiento *</label>
          <input class="sc-input" type="date" id="fecha_nacimiento" name="fecha_nacimiento" required>
        </div>

        <div class="sc-field">
          <label class="sc-label" for="telefono">Tu numero de WhatsApp (EE.UU.) *</label>
          <input class="sc-input" type="tel" id="telefono" name="telefono" placeholder="+1 (555) 123-4567" required>
        </div>

        <div class="sc-field">
          <label class="sc-label" for="plan">Elige tu plan *</label>
          <select class="sc-select" id="plan" name="plan" required onchange="updatePlanDisplay()">
            <option value="basico" selected>Familiar — $12/mes · Hasta 4 personas</option>
            <option value="premium">Premium — $18/mes · Hasta 4 personas + terapia semanal</option>
          </select>
        </div>

        <div class="sc-summary">
          <p class="sc-summary-title">Resumen de tu plan</p>
          <div class="sc-summary-row">
            <span class="sc-summary-label">Hoy pagas</span>
            <span class="sc-summary-value free">$0.00 — GRATIS</span>
          </div>
          <div class="sc-summary-row">
            <span class="sc-summary-label" id="plan-name-label">Plan Familiar</span>
            <span class="sc-summary-value price" id="plan-price-label">$12/mes</span>
          </div>
          <div class="sc-summary-row">
            <span class="sc-summary-label">Primer cobro</span>
            <span class="sc-summary-value">En 30 dias</span>
          </div>
          <div class="sc-summary-row">
            <span class="sc-summary-label">Personas cubiertas</span>
            <span class="sc-summary-value">Hasta 4 en Mexico</span>
          </div>
        </div>

        <p class="sc-section-title" style="margin-top: 28px;">Datos de tu familia en Mexico</p>

        <div class="beneficiary-card" id="beneficiary-1">
          <div class="beneficiary-header">
            <span class="beneficiary-num">Persona 1 (obligatoria)</span>
          </div>
          <div class="sc-field-row" style="display: flex; gap: 1rem;">
          <div class="sc-field" style="flex: 1;">
          <label class="sc-label">Nombre *</label>
          <input class="sc-input" type="text" name="ben1_nombre" placeholder="María" required>
          </div>
          <div class="sc-field" style="flex: 1;">
          <label class="sc-label">Apellido Paterno *</label>
          <input class="sc-input" type="text" name="ben1_apellido" placeholder="García" required>
            </div>
          </div>

          <div class="sc-field">
            <label class="sc-label">Correo electronico en Mexico *</label>
            <input class="sc-input" type="email" name="ben1_email" placeholder="familia@gmail.com" required>
          </div>
          <div class="sc-field">
            <label class="sc-label">Fecha de nacimiento *</label>
            <input class="sc-input" type="date" name="ben1_fecha_nacimiento" required>
          </div>
          <div class="sc-field">
            <label class="sc-label">Su numero de WhatsApp en Mexico *</label>
            <input class="sc-input mx-phone" type="tel" name="ben1_telefono" placeholder="55 1234 5678" required>
          </div>
        </div>

        <div id="extra-beneficiaries"></div>

        <button type="button" class="add-beneficiary" id="btn-add" onclick="addBeneficiary()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/>
          </svg>
          Agregar otra persona (opcional)
        </button>

        <button type="submit" class="cta-primary" style="animation: none; margin-top: 8px;">
          Continuar al pago — Primer mes GRATIS
        </button>

        <div class="cta-subtext">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          Solo completas el pago despues de confirmar los datos
        </div>


        <div class="cta-subtext" style="margin-top: 6px;">
          Tienes otros seres queridos que quieras cuidar? Puedes comprar otra suscripcion despues.
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let beneficiaryCount = 1;
const maxBeneficiaries = 4;

function updatePlanDisplay() {
  const plan = document.getElementById('plan').value;
  const nameLabel = document.getElementById('plan-name-label');
  const priceLabel = document.getElementById('plan-price-label');
  if (plan === 'premium') {
    nameLabel.textContent = 'Plan Premium';
    priceLabel.textContent = '$18/mes';
  } else {
    nameLabel.textContent = 'Plan Familiar';
    priceLabel.textContent = '$12/mes';
  }
}

function formatMxPhoneInput(input) {
  let v = input.value.replace(/\D/g, '');
  if (v.length > 10) v = v.slice(0, 10);
  input.value = v;
}

function bindMxPhoneInputs(scope) {
  scope.querySelectorAll('.mx-phone').forEach((input) => {
    if (input.dataset.mxBound) return;
    input.dataset.mxBound = 'true';
    input.setAttribute('inputmode', 'numeric');
    input.setAttribute('maxlength', '10');
    input.addEventListener('input', () => formatMxPhoneInput(input));
  });
}

function addBeneficiary() {
  if (beneficiaryCount >= maxBeneficiaries) {
    document.getElementById('btn-add').style.display = 'none';
    return;
  }
  beneficiaryCount++;
  const container = document.getElementById('extra-beneficiaries');
  const card = document.createElement('div');
  card.className = 'beneficiary-card';
  card.id = 'beneficiary-' + beneficiaryCount;
  card.innerHTML = `
    <div class="beneficiary-header">
      <span class="beneficiary-num">Persona ${beneficiaryCount} (opcional)</span>
      <button type="button" class="beneficiary-remove" onclick="removeBeneficiary(${beneficiaryCount})">×</button>
    </div>
    <div class="sc-field">
      <label class="sc-label">Nombre completo</label>
      <input class="sc-input" type="text" name="ben${beneficiaryCount}_nombre" placeholder="Nombre apellido">
    </div>
    <div class="sc-field">
      <label class="sc-label">Correo electronico en Mexico</label>
      <input class="sc-input" type="email" name="ben${beneficiaryCount}_email" placeholder="familia@gmail.com">
    </div>
    <div class="sc-field">
      <label class="sc-label">Fecha de nacimiento</label>
      <input class="sc-input" type="date" name="ben${beneficiaryCount}_fecha_nacimiento">
    </div>
    <div class="sc-field">
      <label class="sc-label">Su numero de WhatsApp en Mexico</label>
      <input class="sc-input mx-phone" type="tel" name="ben${beneficiaryCount}_telefono" placeholder="5512345678">
    </div>
  `;
  container.appendChild(card);
  bindMxPhoneInputs(card);
  if (beneficiaryCount >= maxBeneficiaries) {
    document.getElementById('btn-add').style.display = 'none';
  }
}

function removeBeneficiary(num) {
  const card = document.getElementById('beneficiary-' + num);
  if (card) { card.remove(); beneficiaryCount--; }
  document.getElementById('btn-add').style.display = 'flex';
}

function handleRegistroSubmit(e) {
  e.preventDefault();
  const form = document.getElementById('form-registro');
  const formData = new FormData(form);

  const step1 = {
    nombre: formData.get('nombre'),
    email: formData.get('email'),
    fecha_nacimiento: formData.get('fecha_nacimiento'),
    telefono: formData.get('telefono'),
    plan: formData.get('plan')
  };

  const beneficiaries = {};
  for (const [key, value] of formData.entries()) {
    if (key.startsWith('ben')) {
      beneficiaries[key] = value;
    }
  }

  const plan = step1.plan || 'Familiar';

  const variantFamiliar  = 42695875788877;
  const variantPremium = {{ settings.shopify_variant_premium | default: 0 }};
  if (plan === 'premium' && !variantPremium) {
    alert('El plan Premium no esta configurado todavia. Por favor selecciona el Plan Familiar o contacta soporte.');
    return;
  }
  const variantId = plan === 'premium' ? variantPremium : variantFamiliar;

  const shopify_selling_plan_familiar  = {{ settings.shopify_selling_plan_familiar | default: 7685865549 }};
  const spPremium = {{ settings.shopify_selling_plan_premium | default: 0 }};
  const sellingPlanId = plan === 'premium' ? spPremium : spBasico;

  const noteData = `Migrante: ${step1.nombre} | Nacimiento: ${step1.fecha_nacimiento} | Tel: ${step1.telefono} | Plan: ${plan} | Familia: ${JSON.stringify(beneficiaries)}`;

  const submitBtn = document.querySelector('#form-registro button[type=\"submit\"]');
  if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Procesando...'; }

  fetch('/cart/clear.js', { method: 'POST' })
  .then(() => fetch('/cart/add.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      items: [{
        id: 42695875788877,
        quantity: 1,
        selling_plan: sellingPlanId,
        properties: {
          'Nombre migrante': step1.nombre,
          'Email': step1.email,
          'Fecha de nacimiento': step1.fecha_nacimiento,
          'WhatsApp EE.UU.': step1.telefono,
          'Familia Mexico': JSON.stringify(beneficiaries)
        }
      }]
    })
  }))
  .then(res => {
    if (!res.ok) return res.json().then(d => Promise.reject(d));
    return fetch('/cart/update.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ note: noteData })
    });
  })
  .then(() => {
    window.location.href = '/checkout';
  })
  .catch(err => {
    console.error('Checkout error:', err);
    const msg = (err && err.description) ? err.description : 'Ocurrio un error al preparar tu suscripcion. Por favor intenta de nuevo.';
    let errEl = document.getElementById('sc-checkout-error');
    if (!errEl) {
      errEl = document.createElement('p');
      errEl.id = 'sc-checkout-error';
      errEl.style.cssText = 'color:#f87171;background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3);border-radius:8px;padding:12px 16px;margin-top:12px;font-size:14px;';
      submitBtn && submitBtn.parentNode.insertBefore(errEl, submitBtn.nextSibling);
    }
    errEl.textContent = msg;
    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Continuar al pago — Primer mes GRATIS'; }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  bindMxPhoneInputs(document);
});
</script>

{% schema %}
{
  "name": "Registro",
  "settings": [],
  "presets": [
    { "name": "Registro" }
  ]
}
{% endschema %}