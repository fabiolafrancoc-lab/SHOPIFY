<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Instrument+Serif&display=swap');

:root {
  --bg-dark: #0a0a0a;
  --bg-light: #1a1a2E;
  --cyan: #06B6D4;
  --magenta: #EC4899;
  --green: #10B981;
  --gold: #F59E0B;
  --navy-card: #16162a;
  --text-primary: #FFFFFF;
  --text-secondary: rgba(255,255,255,0.75);
  --text-muted: rgba(255,255,255,0.5);
}

*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}

body {
  font-family: 'DM Sans', -apple-system, sans-serif;
  background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2E 100%);
  color: #FFFFFF;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

.serif { font-family: 'Instrument Serif', Georgia, serif; }

/* Confetti */
.confetti-container {
  position: fixed; top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none; z-index: 1000; overflow: hidden;
}
.confetti {
  position: absolute; width: 10px; height: 10px;
  opacity: 0;
  animation: confetti-fall 4s ease-out forwards;
}
@keyframes confetti-fall {
  0%   { opacity: 1; transform: translateY(-100px) rotate(0deg); }
  100% { opacity: 0; transform: translateY(100vh) rotate(720deg); }
}

/* Loading overlay */
.loading-overlay {
  min-height: 100vh;
  display: flex; align-items: center; justify-content: center;
}
.spinner {
  width: 40px; height: 40px;
  border: 3px solid rgba(255,255,255,0.1);
  border-top-color: #06B6D4;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Navigation */
.nav {
  position: sticky; top: 0;
  background: rgba(10,10,10,0.95);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  z-index: 100; padding: 16px 20px;
}
.nav-inner {
  max-width: 1200px; margin: 0 auto;
  display: flex; justify-content: center;
}
.nav-logo { height: 36px; }
.nav-logo-text {
  font-family: 'DM Sans', sans-serif;
  font-size: 22px; font-weight: 700; color: #fff;
  text-decoration: none;
}
.nav-logo-text span { color: var(--cyan); }

/* Page layout */
.success-page {
  max-width: 800px; margin: 0 auto;
  padding: 40px 20px 80px;
  display: flex; flex-direction: column; align-items: center;
}

/* Success header */
.success-header {
  text-align: center;
  margin-bottom: 40px;
}
.success-icon {
  width: 100px; height: 100px;
  background: linear-gradient(135deg, var(--green), #059669);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 24px;
  animation: pulse-success 2s ease-in-out infinite;
  box-shadow: 0 0 40px rgba(16,185,129,0.4);
}
.success-icon svg { width: 50px; height: 50px; color: white; }
@keyframes pulse-success {
  0%,100% { transform: scale(1); box-shadow: 0 0 40px rgba(16,185,129,0.4); }
  50%      { transform: scale(1.05); box-shadow: 0 0 60px rgba(16,185,129,0.6); }
}
.success-title {
  font-size: 42px; font-weight: 400; margin-bottom: 12px;
  background: linear-gradient(135deg, var(--green) 0%, var(--cyan) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.success-subtitle { font-size: 20px; color: var(--text-secondary); }

/* Gratitude section */
.gratitude-section {
  width: 100%; max-width: 900px;
  margin-bottom: 48px; padding: 40px 20px;
  background: linear-gradient(135deg, rgba(22,22,42,0.8), rgba(10,10,10,0.9));
  border-radius: 24px;
  border: 1px solid rgba(255,255,255,0.1);
}
.gratitude-intro {
  text-align: center;
  color: var(--text-muted); font-size: 16px;
  margin-bottom: 32px; font-style: italic;
}
.signatures-cloud {
  display: flex; flex-wrap: wrap;
  justify-content: center; align-items: center;
  gap: 12px 20px; min-height: 320px; padding: 20px;
}
.signature {
  display: inline-block; padding: 4px 12px;
  transition: transform 0.3s ease; cursor: default;
}
.signature:hover { transform: scale(1.15) !important; }

/* Children signatures */
.sig-child { font-family: 'Comic Sans MS', 'Marker Felt', cursive; font-size: 20px; }
.sig-1  { color: #60A5FA; transform: rotate(-5deg); }
.sig-2  { color: #1E3A5F; transform: rotate(3deg);  font-size: 18px; }
.sig-3  { color: #DC2626; transform: rotate(-2deg); font-size: 24px; }
.sig-4  { color: #7C3AED; transform: rotate(4deg); }
.sig-5  { color: #059669; transform: rotate(-6deg); font-size: 22px; }
.sig-6  { color: #60A5FA; transform: rotate(2deg);  font-size: 19px; }
.sig-7  { color: #EC4899; transform: rotate(-3deg); font-size: 21px; }
.sig-8  { color: #1E3A5F; transform: rotate(5deg);  font-size: 17px; }
.sig-17 { color: #DC2626; transform: rotate(-4deg); font-size: 20px; }
.sig-18 { color: #7C3AED; transform: rotate(3deg);  font-size: 23px; }
.sig-21 { color: #059669; transform: rotate(-2deg); font-size: 18px; }
.sig-22 { color: #60A5FA; transform: rotate(4deg);  font-size: 22px; }

/* Elder signatures */
.sig-elder { font-family: 'Brush Script MT', 'Segoe Script', cursive; font-size: 26px; }
.sig-9  { color: #A78BFA; transform: rotate(2deg); }
.sig-10 { color: #34D399; transform: rotate(-3deg); font-size: 24px; }
.sig-11 { color: #F472B6; transform: rotate(4deg); }
.sig-12 { color: #60A5FA; transform: rotate(-2deg); font-size: 28px; }
.sig-13 { color: #FCD34D; transform: rotate(3deg);  font-size: 25px; }
.sig-14 { color: #A78BFA; transform: rotate(-4deg); }
.sig-15 { color: #34D399; transform: rotate(2deg);  font-size: 23px; }
.sig-16 { color: #F472B6; transform: rotate(-3deg); font-size: 27px; }
.sig-19 { color: #60A5FA; transform: rotate(3deg);  font-size: 24px; }
.sig-20 { color: #FCD34D; transform: rotate(-2deg); font-size: 26px; }
.sig-23 { color: #A78BFA; transform: rotate(4deg);  font-size: 25px; }
.sig-24 { color: #34D399; transform: rotate(-3deg); }

/* Codes section */
.codes-section {
  width: 100%; max-width: 600px;
  margin-bottom: 40px;
}
.codes-title {
  text-align: center; font-size: 24px; font-weight: 600;
  margin-bottom: 24px; color: var(--text-primary);
}
.code-card {
  background: var(--navy-card);
  border-radius: 20px; padding: 24px;
  margin-bottom: 16px;
  border: 1px solid rgba(255,255,255,0.1);
}
.code-card-header {
  display: flex; align-items: center;
  gap: 16px; margin-bottom: 20px;
}
.code-card-flag { font-size: 32px; }
.code-card-info h3 {
  font-size: 18px; font-weight: 600;
  color: var(--text-primary); margin-bottom: 4px;
}
.code-card-info p { font-size: 14px; color: var(--text-muted); }
.code-display {
  background: rgba(0,0,0,0.3);
  border-radius: 12px; padding: 20px;
  text-align: center; margin-bottom: 16px;
}
.code-label {
  font-size: 12px; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 1px;
  margin-bottom: 8px;
}
.code-value {
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 32px; font-weight: 700; letter-spacing: 6px;
}
.code-value.cyan   { color: var(--cyan);    text-shadow: 0 0 20px rgba(6,182,212,0.5); }
.code-value.magenta{ color: var(--magenta); text-shadow: 0 0 20px rgba(236,72,153,0.5); }
.code-sent {
  display: flex; align-items: center;
  justify-content: center; gap: 8px;
  color: var(--green); font-size: 14px;
}
.code-sent svg { width: 18px; height: 18px; }

/* Next steps */
.next-steps {
  width: 100%; max-width: 600px;
  margin-bottom: 40px;
}
.next-steps-title {
  text-align: center; font-size: 20px; font-weight: 600;
  margin-bottom: 24px; color: var(--text-primary);
}
.step-item {
  display: flex; gap: 16px; padding: 20px;
  background: var(--navy-card); border-radius: 16px;
  margin-bottom: 12px;
  border: 1px solid rgba(255,255,255,0.05);
}
.step-icon {
  width: 48px; height: 48px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; font-size: 24px;
}
.step-icon.whatsapp { background: linear-gradient(135deg, #25D366, #128C7E); }
.step-icon.phone    { background: linear-gradient(135deg, var(--magenta), #BE185D); }
.step-icon.check    { background: linear-gradient(135deg, var(--green), #059669); }
.step-content h4 {
  font-size: 16px; font-weight: 600;
  color: var(--text-primary); margin-bottom: 4px;
}
.step-content p { font-size: 14px; color: var(--text-muted); }
.companion-name { color: var(--magenta); font-weight: 600; }

/* CTA button */
.cta-button {
  display: inline-flex; align-items: center;
  justify-content: center; gap: 12px;
  background: linear-gradient(135deg, var(--cyan), #0891B2);
  color: white; font-size: 18px; font-weight: 700;
  padding: 18px 48px; border-radius: 16px;
  border: none; cursor: pointer;
  text-decoration: none; transition: all 0.3s ease;
  box-shadow: 0 8px 32px rgba(6,182,212,0.3);
}
.cta-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(6,182,212,0.4);
}

/* Error state */
.error-box {
  text-align: center; padding: 40px 24px;
  background: rgba(239,68,68,0.08);
  border: 1px solid rgba(239,68,68,0.2);
  border-radius: 20px; max-width: 500px;
  margin: 40px auto;
}
.error-box h2 { color: #EF4444; margin-bottom: 12px; }
.error-box p  { color: var(--text-muted); font-size: 15px; }

@media (max-width: 640px) {
  .success-title   { font-size: 28px; }
  .code-value      { font-size: 24px; letter-spacing: 4px; }
  .signatures-cloud{ gap: 8px 14px; min-height: 280px; }
  .signature       { padding: 2px 8px; }
  .sig-child       { font-size: 16px !important; }
  .sig-elder       { font-size: 20px !important; }
  .cta-button      { width: 100%; padding: 16px 24px; font-size: 16px; }
}
</style>

<!-- Confetti container -->
<div class="confetti-container" id="confetti-container"></div>

<!-- Loading state (shown until data loads) -->
<div class="loading-overlay" id="loading-state">
  <div style="text-align:center">
    <div class="spinner"></div>
    <p>Cargando confirmaciÃ³n...</p>
  </div>
</div>

<!-- Main content (hidden until data loads) -->
<div id="main-content" style="display:none">

  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-inner">
      {% if settings.logo %}
        <img src="{{ settings.logo | img_url: '200x' }}" alt="SaludCompartida" class="nav-logo">
      {% else %}
        <a href="/" class="nav-logo-text">Salud<span>Compartida</span></a>
      {% endif %}
    </div>
  </nav>

  <div class="success-page">

    <!-- Success Header -->
    <div class="success-header">
      <div class="success-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      </div>
      <h1 class="success-title serif">Â¡Pago exitoso!</h1>
      <p class="success-subtitle">Tu familia en MÃ©xico ya estÃ¡ protegida</p>
    </div>

    <!-- Gratitude Section â€” handwritten signatures -->
    <div class="gratitude-section">
      <p class="gratitude-intro">Esto es lo que las familias quieren decirte...</p>
      <div class="signatures-cloud">
        <!-- Children â€” big, messy, spelling errors -->
        <span class="signature sig-child sig-1">Gracias papÃ¡</span>
        <span class="signature sig-child sig-2">gracias mami</span>
        <span class="signature sig-child sig-3">Grasias Papa</span>
        <span class="signature sig-child sig-4">te quiero mamÃ¡</span>
        <span class="signature sig-child sig-5">GRACIAS TÃO</span>
        <span class="signature sig-child sig-6">gracias papi</span>
        <span class="signature sig-child sig-7">Te extraÃ±o</span>
        <span class="signature sig-child sig-8">grasias mama</span>
        <!-- Elders â€” elegant cursive -->
        <span class="signature sig-elder sig-9">Gracias, mijo</span>
        <span class="signature sig-elder sig-10">Bendiciones, mijita</span>
        <span class="signature sig-elder sig-11">Gracias, mi niÃ±o</span>
        <span class="signature sig-elder sig-12">Dios te bendiga, hija</span>
        <span class="signature sig-elder sig-13">Mil gracias, mijo</span>
        <span class="signature sig-elder sig-14">Te quiero mucho, mijita</span>
        <span class="signature sig-elder sig-15">Gracias por no olvidarnos</span>
        <span class="signature sig-elder sig-16">Que Dios te lo pague</span>
        <!-- More children -->
        <span class="signature sig-child sig-17">ya no me duele</span>
        <span class="signature sig-child sig-18">Gracias Papito</span>
        <span class="signature sig-child sig-21">tenkiu mami</span>
        <span class="signature sig-child sig-22">gracias por la mesina</span>
        <!-- More elders -->
        <span class="signature sig-elder sig-19">Siempre en mi corazÃ³n</span>
        <span class="signature sig-elder sig-20">Gracias por cuidarnos</span>
        <span class="signature sig-elder sig-23">Te recordamos siempre</span>
        <span class="signature sig-elder sig-24">Eres nuestra bendiciÃ³n</span>
      </div>
    </div>

    <!-- Codes Section -->
    <div class="codes-section">
      <h2 class="codes-title">Tus cÃ³digos de acceso</h2>

      <!-- Migrant code card -->
      <div class="code-card">
        <div class="code-card-header">
          <span class="code-card-flag">ğŸ‡ºğŸ‡¸</span>
          <div class="code-card-info">
            <h3>Para ti (<span id="migrant-name">Titular</span>)</h3>
            <p>Acceso al panel de ahorros y seguimiento</p>
          </div>
        </div>
        <div class="code-display">
          <div class="code-label">Tu cÃ³digo de acceso</div>
          <div class="code-value cyan" id="migrant-code">Â·Â·Â·</div>
        </div>
        <div class="code-sent">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Enviado a tu WhatsApp y email
        </div>
      </div>

      <!-- Family code card -->
      <div class="code-card">
        <div class="code-card-header">
          <span class="code-card-flag">ğŸ‡²ğŸ‡½</span>
          <div class="code-card-info">
            <h3>Para tu familia (<span id="family-name">en MÃ©xico</span>)</h3>
            <p>Acceso a telemedicina, farmacia y compaÃ±Ã­a</p>
          </div>
        </div>
        <div class="code-display">
          <div class="code-label">CÃ³digo de tu familia</div>
          <div class="code-value magenta" id="family-code">Â·Â·Â·</div>
        </div>
        <div class="code-sent">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Enviado por WhatsApp a MÃ©xico
        </div>
      </div>
    </div>

    <!-- Next Steps -->
    <div class="next-steps">
      <h3 class="next-steps-title">Â¿QuÃ© sigue?</h3>

      <div class="step-item">
        <div class="step-icon whatsapp">ğŸ“±</div>
        <div class="step-content">
          <h4>WhatsApp enviado</h4>
          <p>Tu familia ya recibiÃ³ su cÃ³digo y las instrucciones</p>
        </div>
      </div>

      <div class="step-item">
        <div class="step-icon phone">ğŸ“</div>
        <div class="step-content">
          <h4>Llamada de bienvenida</h4>
          <p>En las prÃ³ximas 24 horas, <span class="companion-name" id="companion-name">ğŸ‘µ Lupita</span> llamarÃ¡ a tu familia para presentarse</p>
        </div>
      </div>

      <div class="step-item">
        <div class="step-icon check">âœ“</div>
        <div class="step-content">
          <h4>Servicios activos</h4>
          <p>Telemedicina, farmacia, terapia y compaÃ±Ã­a ya estÃ¡n disponibles</p>
        </div>
      </div>
    </div>

    <!-- CTA -->
    <a href="/pages/dashboard" class="cta-button">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
        <polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
      Ir a mi panel de ahorros
    </a>

  </div><!-- /.success-page -->
</div><!-- /#main-content -->

<script>
(function() {
  // â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Replace these with your real credentials in Shopify Admin > Code editor
  var SUPABASE_URL  = '{{ settings.supabase_url | default: "SUPABASE_URL_PLACEHOLDER" }}';
  var SUPABASE_ANON = '{{ settings.supabase_anon_key | default: "SUPABASE_ANON_KEY_PLACEHOLDER" }}';
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // â”€â”€ CONFETTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function spawnConfetti() {
    var container = document.getElementById('confetti-container');
    var colors = ['#06B6D4','#EC4899','#10B981','#F59E0B','#8B5CF6'];
    for (var i = 0; i < 100; i++) {
      var el = document.createElement('div');
      el.className = 'confetti';
      el.style.left              = (Math.random() * 100) + '%';
      el.style.animationDelay    = (Math.random() * 3) + 's';
      el.style.backgroundColor   = colors[Math.floor(Math.random() * 5)];
      el.style.borderRadius      = Math.random() > 0.5 ? '50%' : '0';
      container.appendChild(el);
    }
    setTimeout(function() { container.style.display = 'none'; }, 6000);
  }

  // â”€â”€ SHOW MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showPage(data) {
    // Populate codes
    document.getElementById('migrant-code').textContent =
      (data && data.migrant_code) ? data.migrant_code : 'â€”';
    document.getElementById('family-code').textContent  =
      (data && data.family_code)  ? data.family_code  : 'â€”';

    // Populate names
    if (data) {
      var mName = [data.nombre, data.apellido1].filter(Boolean).join(' ');
      if (mName) document.getElementById('migrant-name').textContent = mName;

      // companion assigned (if stored in policy_holders)
      if (data.companion_assigned === 'fernanda') {
        document.getElementById('companion-name').textContent = 'ğŸ‘© Fernanda';
      }
    }

    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('main-content').style.display  = 'block';
    spawnConfetti();
  }

  // â”€â”€ SHOW ERROR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showError(msg) {
    document.getElementById('loading-state').innerHTML =
      '<div class="error-box">' +
        '<h2>Algo saliÃ³ mal</h2>' +
        '<p>' + (msg || 'No pudimos verificar tu registro.') + '</p>' +
        '<p style="margin-top:16px">EscrÃ­benos a <a href="mailto:hola@saludcompartida.com" style="color:#06B6D4">hola@saludcompartida.com</a></p>' +
      '</div>';
  }

  // â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var params  = new URLSearchParams(window.location.search);
  var email   = params.get('email');

  if (!email || SUPABASE_URL === 'SUPABASE_URL_PLACEHOLDER') {
    // No email param or credentials not configured â€” show page without codes
    showPage(null);
    return;
  }

  // Lookup policy_holder by email to get migrant_code and family_code
  fetch(
    SUPABASE_URL + '/rest/v1/policy_holders' +
      '?email=eq.' + encodeURIComponent(email) +
      '&select=nombre,apellido1,migrant_code,family_code,companion_assigned' +
      '&limit=1',
    {
      headers: {
        'apikey':        SUPABASE_ANON,
        'Authorization': 'Bearer ' + SUPABASE_ANON
      }
    }
  )
  .then(function(res) { return res.json(); })
  .then(function(rows) {
    showPage(rows && rows.length > 0 ? rows[0] : null);
  })
  .catch(function(err) {
    console.error('Error loading registration:', err);
    showPage(null); // show page gracefully even if lookup fails
  });

})();
</script>
